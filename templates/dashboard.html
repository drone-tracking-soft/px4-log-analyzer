{% extends "base.html" %}

{% block content %}
<div class="dashboard">
    <!-- –®–∞–ø–∫–∞ -->
    <div class="dashboard-header">
        <h2>üìä –ê–Ω–∞–ª–∏–∑: {{ filename }}</h2>
        <div class="file-meta">
            <span>üïì {{ metadata.duration }}</span>
            <span>‚úàÔ∏è {{ metadata.vehicle_type }}</span>
            <span>üîß {{ metadata.firmware }}</span>
        </div>
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
    <div class="metrics-grid">
        {% if metrics.gps %}
        <div class="metric-card">
            <h3>üìç GPS</h3>
            <div class="metric-value">{{ metrics.gps.max_alt }}</div>
            <div class="metric-label">–ú–∞–∫—Å. –≤—ã—Å–æ—Ç–∞</div>
            <div class="metric-value">{{ metrics.gps.max_speed }}</div>
            <div class="metric-label">–ú–∞–∫—Å. —Å–∫–æ—Ä–æ—Å—Ç—å</div>
        </div>
        {% endif %}
        
        {% if metrics.battery %}
        <div class="metric-card">
            <h3>üîã –ë–∞—Ç–∞—Ä–µ—è</h3>
            <div class="metric-value">{{ metrics.battery.max_voltage }}</div>
            <div class="metric-label">–ú–∞–∫—Å. –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ</div>
            <div class="metric-value">{{ metrics.battery.min_voltage }}</div>
            <div class="metric-label">–ú–∏–Ω. –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ</div>
        </div>
        {% endif %}
        
        <div class="metric-card">
            <h3>üìà –û–±—â–µ–µ</h3>
            <div class="metric-value">{{ metadata.duration }}</div>
            <div class="metric-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
            <div class="metric-value">{{ metadata.topics_count }}</div>
            <div class="metric-label">–¢–æ–ø–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö</div>
        </div>
    </div>
    
    <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
    <div class="charts-section">
        <h3>üìà –ì—Ä–∞—Ñ–∏–∫–∏ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏</h3>
        
        <div class="chart-controls">
            <select id="topicSelect">
                {% for topic in topics[:10] %}
                <option value="{{ topic }}">{{ topic }}</option>
                {% endfor %}
            </select>
            <button class="btn" onclick="loadChart()">–ü–æ–∫–∞–∑–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫</button>
            <button class="btn secondary" onclick="exportCSV()">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
        </div>
        
        <div id="chartContainer" class="chart-container">
            <!-- –°—é–¥–∞ –≤—Å—Ç–∞–≤–∏—Ç—Å—è Plotly –≥—Ä–∞—Ñ–∏–∫ -->
            <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–ø–∏–∫ –∏ –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–∫–∞–∑–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫"</p>
        </div>
    </div>
    
    <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="actions">
        <a href="/" class="btn">‚¨ÖÔ∏è –ù–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑</a>
        <button class="btn secondary" onclick="location.reload()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
</div>

<script>
const fileId = '{{ file_id }}';

function loadChart() {
    const topic = document.getElementById('topicSelect').value;
    const container = document.getElementById('chartContainer');
    
    container.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞...</p>';
    
    fetch(`/api/log/${fileId}/chart/${topic}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                container.innerHTML = `<p class="error">${data.error}</p>`;
                return;
            }
            
            Plotly.newPlot('chartContainer', data.chart.data, data.chart.layout);
        })
        .catch(error => {
            container.innerHTML = `<p class="error">–û—à–∏–±–∫–∞: ${error.message}</p>`;
        });
}

function exportCSV() {
    const topic = document.getElementById('topicSelect').value;
    window.open(`/api/log/${fileId}/export/csv?topic=${topic}`, '_blank');
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—ã–π –≥—Ä–∞—Ñ–∏–∫
window.onload = function() {
    if (document.getElementById('topicSelect').value) {
        setTimeout(loadChart, 500);
    }
};
</script>
{% endblock %}